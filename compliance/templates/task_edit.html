{% extends "base_generic.html" %}
{% load django_bootstrap5 %}

{% block content %}

<div class="container">

    <div class="container my-5">
        <div class="row">
            <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
                <h1>Compliance Task: {{ task.task_name }}</h1>
                <div>
                    <a href="{% url 'task_edit' task.pk %}" class="btn btn-warning me-2">
                        <i class="bi bi-pencil-square"></i> Edit Task
                    </a>
                    <a href="{% url 'task_list' filter='overdue' %}" class="btn btn-secondary">
                        <i class="bi bi-list"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card mb-4 shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">General Details</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Task Name</dt>
                            <dd class="col-sm-7">{{ task.task_name }}</dd>

                            <dt class="col-sm-5">Current Status</dt>
                            <dd class="col-sm-7">
                                <span class="badge
                        {% if task.current_status == 'pending' %}bg-danger{% elif task.current_status == 'submitted' %}bg-success{% else %}bg-secondary{% endif %}
                        fs-6">
                                    {{ task.get_current_status_display }}
                                </span>
                            </dd>

                            <dt class="col-sm-5">Priority</dt>
                            <dd class="col-sm-7">
                                <span class="badge
                        {% if task.priority == 3 %}bg-danger{% elif task.priority == 2 %}bg-warning text-dark{% else %}bg-info text-dark{% endif %}
                        fs-6">
                                    {{ task.get_priority_display }}
                                </span>
                            </dd>

                            <dt class="col-sm-5">Department</dt>
                            <dd class="col-sm-7">{{ task.get_department_display|default:"N/A" }}</dd>


                        </dl>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card mb-4 shadow-sm h-100">
                    <div class="card-header bg-info text-dark">
                        <h5 class="mb-0">Compliance & Recurrence</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Type of Compliance</dt>
                            <dd class="col-sm-4">{{ task.get_type_of_compliance_display|default:"Adhoc" }}</dd>

                            <dt class="col-sm-5">Return Number</dt>
                            <dd class="col-sm-4">{{ task.return_number|default:"N/A" }}</dd>

                            <dt class="col-sm-5">Circular/Regulation</dt>
                            <dd class="col-sm-4 word-wrap">{{ task.circular_details|default:"No details provided." }}
                            </dd>
                            <dt class="col-sm-5">Circular Document</dt>
                            <dd class="col-sm-4">
                                {% if task.circular_document %}
                                <a href="{{ task.circular_document.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-text"></i> View File
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">

            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Dates & Contacts</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-5">Due Date</dt>
                            <dd class="col-sm-7">{{ task.due_date|date:"d/m/Y"|default:"Not Set" }}</dd>



                            <dt class="col-sm-5">UIIC Contact</dt>
                            <dd class="col-sm-7">{{ task.uiic_contact|default:"N/A" }}</dd>

                            <dt class="col-sm-5">Compliance Contact</dt>
                            <dd class="col-sm-7">{{ task.compliance_contact|default:"N/A" }}</dd>

                            <dt class="col-sm-5">Date Received</dt>
                            <dd class="col-sm-7">{{ task.date_of_document_received|default:"N/A" }}</dd>

                            <dt class="col-sm-5">Date Forwarded</dt>
                            <dd class="col-sm-7">{{ task.date_of_document_forwarded|default:"N/A" }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm mb-4 h-100">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Attached Documents</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">

                            <dt class="col-sm-8">Data format</dt>
                            <dd class="col-sm-4">
                                {% if task.data_document_template %}
                                <a href="{{ task.data_document_template.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-envelope-in"></i> View File
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </dd>
                            <dt class="col-sm-8">Data Document</dt>
                            <dd class="col-sm-4">
                                {% if task.data_document %}
                                <a href="{{ task.data_document.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-earmark-bar-graph"></i> View File
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </dd>
                            <dt class="col-sm-8">Inbound Email Communication</dt>
                            <dd class="col-sm-4">
                                {% if task.inbound_email_communication %}
                                <a href="{{ task.inbound_email_communication.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-envelope-in"></i> View File
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </dd>

                            <dt class="col-sm-8">Outbound Email Communication</dt>
                            <dd class="col-sm-4">
                                {% if task.outbound_email_communication %}
                                <a href="{{ task.outbound_email_communication.url }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-envelope-out"></i> View File
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </dd>


                        </dl>
                    </div>
                </div>

            </div>
        </div>


        <div class="card shadow mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Audit Log</h5>
            </div>
            <div class="card-body small text-muted">
                <dl class="row mb-0">
                    <dt class="col-sm-3">Created By</dt>
                    <dd class="col-sm-9">{{ task.created_by|default:"System" }} on {{ task.created_on|date:"F d, Y P" }}
                    </dd>

                    <dt class="col-sm-3">Last Updated By</dt>
                    <dd class="col-sm-9">{{ task.updated_by|default:"System" }} on {{ task.updated_on|date:"F d, Y P" }}
                    </dd>
                </dl>
            </div>
        </div>
        <div class="card shadow mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Status Change History</h5>
            </div>
            <div class="card-body small">

                {% if status_audit_logs %}
                <ul class="list-group list-group-flush">
                    {% for log in status_audit_logs %}
                    {% with old=log.changes.current_status.0 new=log.changes.current_status.1 %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ log.actor.get_full_name|default:log.actor.username|default:"System" }}</strong>
                                changed status from
                                <span class="badge bg-secondary">{{ old }}</span>
                                â†’
                                <span class="badge bg-primary">{{ new }}</span>
                            </div>
                            <small class="text-muted">
                                {{ log.timestamp|date:"d M Y H:i" }}
                            </small>
                        </div>
                    </li>
                    {% endwith %}
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-info mb-0">
                    No status changes recorded.
                </div>
                {% endif %}

            </div>
        </div>








        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Upload documents for {{ task.task_name }}</h5>
            </div>

            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-lg-6">
                            {% bootstrap_field form.data_document layout="vertical" %}
                        </div>
                        <div class="col-lg-6">
                            {% bootstrap_field form.inbound_email_communication layout="vertical" %}
                        </div>
                    </div>

                    <hr>

                    <h5 class="mt-4 text-secondary">Existing Remarks</h5>
                    {% if task.remarks.all %}
                    {% for remark in task.remarks.all %}
                    <div class="mb-3 p-3 border-start border-4 border-info rounded bg-light">
                        <p class="mb-1">{{ remark.text }}</p>
                        <small class="text-muted">
                            Added by: <strong>{{ remark.creator_name }}</strong>
                            on {{ remark.created_at|date:"d M Y H:i" }}
                        </small>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-info small">No remarks have been added for this task yet.</div>
                    {% endif %}

                    <hr>

                    <h5 class="mt-4 text-secondary">Add New Remarks</h5>

                    {{ remarks_formset.management_form }}
                    {% for formset_form in remarks_formset %}
                    <div class="mb-3 p-3 border rounded bg-white">
                        {% bootstrap_form formset_form layout="vertical" %}
                    </div>
                    {% endfor %}

                    <div class="text-center mt-4">
                        {% bootstrap_button button_type="submit" content="Submit Update" btn_class="btn-success" %}
                        <a href="{% url 'task_detail' task.pk %}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>


</div>
{% endblock content %}
