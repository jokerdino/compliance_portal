<div class="row">
    <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
        <h1>Compliance Task: {{ task.task_name }}</h1>

    </div>
</div>
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card mb-4 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">General Details</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Task Name</dt>
                    <dd class="col-sm-7">
                        {{ task.task_name }}
                    </dd>
                    <dt class="col-sm-5">Current Status</dt>
                    <dd class="col-sm-7">
                        <span
                            class="badge {% if task.current_status == 'pending' %}bg-danger{% elif task.current_status == 'submitted' %}bg-success{% else %}bg-secondary{% endif %} fs-6">
                            {{ task.get_current_status_display }}
                        </span>
                    </dd>
                    <dt class="col-sm-5">Priority</dt>
                    <dd class="col-sm-7">
                        <span
                            class="badge {% if task.priority == 3 %}bg-danger{% elif task.priority == 2 %}bg-warning text-dark{% else %}bg-info text-dark{% endif %} fs-6">
                            {{ task.get_priority_display }}
                        </span>
                    </dd>
                    <dt class="col-sm-5">Department</dt>
                    <dd class="col-sm-7">
                        {{ task.get_department_display|default:"N/A" }}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card mb-4 shadow-sm h-100">
            <div class="card-header bg-info text-dark">
                <h5 class="mb-0">Compliance & Recurrence</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Type of Compliance</dt>
                    <dd class="col-sm-4">
                        {{ task.get_type_of_compliance_display|default:"Adhoc" }}
                    </dd>
                    <dt class="col-sm-5">Return Number</dt>
                    <dd class="col-sm-4">
                        {{ task.return_number|default:"N/A" }}
                    </dd>
                    <dt class="col-sm-5">Source circular URL</dt>
                    <dd class="col-sm-4">{% if task.circular_url %}
                        <a class="btn btn-sm btn-outline-primary" href="{{ task.circular_url }}" target="_blank">
                            Source circular URL</a>
                        {% else %}
                        "N/A"
                        {% endif %}
                    </dd>
                    <dt class="col-sm-5">Circular/Regulation</dt>
                    <dd class="col-sm-4 word-wrap">
                        {{ task.circular_details|default:"No details provided." }}
                    </dd>
                    <dt class="col-sm-5">Circular Document</dt>
                    <dd class="col-sm-4">
                        {% if task.circular_document %}
                        <a href="{{ task.circular_document.url }}" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-file-earmark-text"></i> View File
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Dates & Contacts</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Due Date</dt>
                    <dd class="col-sm-7">
                        {{ task.due_date|date:"d/m/Y"|default:"Not Set" }}
                    </dd>
                    <dt class="col-sm-5">UIIC Contact</dt>
                    <dd class="col-sm-7">
                        {{ task.uiic_contact|default:"N/A" }}
                    </dd>
                    <dt class="col-sm-5">Compliance Contact</dt>
                    <dd class="col-sm-7">
                        {{ task.compliance_contact|default:"N/A" }}
                    </dd>
                    <dt class="col-sm-5">Date of document received</dt>
                    <dd class="col-sm-7">
                        {{ task.date_of_document_received|date:"d/m/Y"|default:"N/A" }}
                    </dd>
                    <dt class="col-sm-5">Date of submission to IRDA</dt>
                    <dd class="col-sm-7">
                        {{ task.date_of_document_forwarded|date:"d/m/Y"|default:"N/A" }}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm mb-4 h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Attached Documents</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-8">Data format</dt>
                    <dd class="col-sm-4">
                        {% if task.data_document_template %}
                        <a href="{{ task.data_document_template.url }}" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-envelope-in"></i> View File
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </dd>
                    <dt class="col-sm-8">Data Document</dt>
                    <dd class="col-sm-4">
                        {% if task.data_document %}
                        <a href="{{ task.data_document.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-file-earmark-bar-graph"></i> View File
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </dd>
                    <dt class="col-sm-8">Inbound Email Communication</dt>
                    <dd class="col-sm-4">
                        {% if task.inbound_email_communication %}
                        <a href="{{ task.inbound_email_communication.url }}" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-envelope-in"></i> View File
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </dd>
                    <dt class="col-sm-8">Outbound Email Communication</dt>
                    <dd class="col-sm-4">
                        {% if task.outbound_email_communication %}
                        <a href="{{ task.outbound_email_communication.url }}" target="_blank"
                            class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-envelope-out"></i> View File
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
</div>
<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Audit Log</h5>
    </div>
    <div class="card-body small text-muted">
        <dl class="row mb-0">
            <dt class="col-sm-3">Created By</dt>
            <dd class="col-sm-9">
                {{ task.created_by|default:"System" }} on {{ task.created_on|date:"F d, Y P" }}
            </dd>
            <dt class="col-sm-3">Last Updated By</dt>
            <dd class="col-sm-9">
                {{ task.updated_by|default:"System" }} on {{ task.updated_on|date:"F d, Y P" }}
            </dd>
        </dl>
    </div>
</div>
<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Status Change History</h5>
    </div>
    <div class="card-body small">
        {% if status_audit_logs %}
        <ul class="list-group list-group-flush">
            {% for log in status_audit_logs %}
            {% with old=log.changes.current_status.0 new=log.changes.current_status.1 %}
            <li class="list-group-item">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>{{ log.actor.get_full_name|default:log.actor.username|default:"System" }}
                        </strong>
                        changed status from
                        <span class="badge bg-secondary">{{ old }}</span>
                        â†’
                        <span class="badge bg-primary">{{ new }}</span>
                    </div>
                    <small class="text-muted">{{ log.timestamp|date:"d M Y H:i" }}</small>
                </div>
            </li>
            {% endwith %}
            {% endfor %}
        </ul>
        {% else %}
        <div class="alert alert-info mb-0">No status changes recorded.</div>
        {% endif %}
    </div>
</div>
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Remarks</h5>
            </div>
            <div class="card-body">
                {% if task.remarks.all %}
                {% for remark in task.remarks.all %}
                <div class="mb-3 p-3 border-start border-4 border-info rounded bg-light">
                    <p class="mb-1 text-word-wrap">{{ remark.text }}</p>
                    <small class="text-muted">
                        Added by: <strong>{{ remark.creator_name }}</strong> on
                        {{ remark.created_at|date:"d M Y H:i" }}
                    </small>
                </div>
                {% endfor %}
                {% else %}
                <div class="alert alert-info small">No remarks have been added for this task yet.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .text-word-wrap {
        white-space: pre-wrap;
    }
</style>
{% endblock extra_css %}
